upstream postgrest {
    server supabase-rest:3000;
}

server {
    listen 3000;
    server_name _;

    # Supabase client expects /rest/v1/* but PostgREST serves at root
    location /rest/v1/ {
        # Strip /rest/v1 prefix and proxy to PostgREST root
        rewrite ^/rest/v1/(.*)$ /$1 break;
        proxy_pass http://postgrest;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        # Pass through Supabase headers
        proxy_set_header apikey $http_apikey;
        proxy_set_header Authorization $http_authorization;
        proxy_set_header Prefer $http_prefer;
        proxy_set_header Content-Type $http_content_type;
        proxy_set_header Accept $http_accept;
    }

    # Direct access to PostgREST root (for health checks, etc.)
    location / {
        proxy_pass http://postgrest;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header apikey $http_apikey;
        proxy_set_header Authorization $http_authorization;
    }
}
