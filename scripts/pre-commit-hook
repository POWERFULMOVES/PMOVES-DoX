#!/usr/bin/env bash
# =============================================================================
# Pre-commit Hook for PMOVES.AI Infrastructure Validation
# =============================================================================
# This hook runs validation before commits.
#
# Installation:
#   ln -s ../../scripts/pre-commit-hook .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
#
# Or use the pre-commit framework:
#   pip install pre-commit
#   pre-commit install
# =============================================================================

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Get the project root
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# Check if we should skip validation
if git diff --cached --name-only | grep -qE '^scripts/validate-changes\.sh$'; then
    # Allow changes to the validation script itself
    exit 0
fi

# Check if infrastructure files were changed
CHANGED_INFRA_FILES=$(git diff --cached --name-only | grep -E '(docker-compose.*\.yml|\.env\.example|env\.shared|Makefile)$' || true)

if [ -z "$CHANGED_INFRA_FILES" ]; then
    # No infrastructure files changed, skip validation
    exit 0
fi

echo -e "${YELLOW}[INFO]${NC} Infrastructure files changed: $CHANGED_INFRA_FILES"
echo -e "${YELLOW}[INFO]${NC} Running infrastructure validation..."

# Run the validation script in fast mode
if bash "${PROJECT_ROOT}/scripts/validate-changes.sh" --fast --ci; then
    echo -e "${GREEN}[PASS]${NC} Infrastructure validation passed"
    exit 0
else
    echo -e "${RED}[FAIL]${NC} Infrastructure validation failed"
    echo ""
    echo "To bypass this check (not recommended), commit with:"
    echo "  git commit --no-verify"
    exit 1
fi
