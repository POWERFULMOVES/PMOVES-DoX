name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Build backend (CPU)
        working-directory: meeting-analyst-app
        run: |
          docker compose -f docker-compose.cpu.yml build backend
      - name: Run backend
        working-directory: meeting-analyst-app
        run: |
          docker compose -f docker-compose.cpu.yml up -d backend
      - name: Wait for health
        run: |
          for i in {1..30}; do curl -fsS http://localhost:8000/health && exit 0 || sleep 2; done; exit 1
      - name: Install smoke deps
        working-directory: meeting-analyst-app
        run: |
          python -m pip install --upgrade pip
          pip install -r smoke/requirements.txt
      - name: Run smoke
        working-directory: meeting-analyst-app
        env:
          API_BASE: http://localhost:8000
        run: python smoke/smoke_backend.py
      - name: Teardown
        if: always()
        working-directory: meeting-analyst-app
        run: docker compose -f docker-compose.cpu.yml down -v

  smoke-gpu:
    # Requires a self-hosted runner with NVIDIA GPU + Container Toolkit
    runs-on: [self-hosted, linux, x64, gpu]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install smoke deps
        working-directory: meeting-analyst-app
        run: |
          python -m pip install --upgrade pip
          pip install -r smoke/requirements.txt requests
      - name: Run GPU smoke via docker compose
        working-directory: meeting-analyst-app
        env:
          SMOKE_COMPOSE: docker-compose.yml
          SMOKE_FLAGS: --compatibility
          API_BASE: http://localhost:8000
        run: |
          python smoke/run_smoke_docker.py
